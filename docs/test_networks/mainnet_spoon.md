# Starting a test chain from state taken from mainnet or testnet

## Purpose

For testing purposes, it is often desirable to start a test chain with
a starting state that looks like mainnet or testnet. This is usually
done for the purpose of testing changes to neard itself, but it's also
possible to do this if you're a contract developer and want to see
what a change to your contract would look like on top of the current
mainnet state. At the end of the process described here, you'll have
a set of genesis records that can be used to start your own test chain,
that'll be like any other test chain like the ones generated by the
`neard localnet` command, except with account balances and data taken
from mainnet

## How-to

The first step is to obtain an RPC node home directory for the chain
you'd like to spoon. So if you want to use mainnet state, you can
follow the instructions
[here](https://near-nodes.io/rpc/run-rpc-node-without-nearup#5-get-data-backup-1)
to obtain a recent snapshot of a mainnet node's home directory. Once
you have your node's home directory set up, run the following
`state-viewer` command to generate a dump of the chain's state:

```shell
$ neard --home $NEAR_HOME_DIRECTORY view-state dump-state --stream
```

This command will take a while (possibly many hours) to run. But at the
end you should have `genesis.json` and `records.json` files in
`$NEAR_HOME_DIRECTORY/output`. This records file represents all of the
chain's current state, and is what we'll use to start our chain.

From here, we need to make some changes to the `genesis.json` that was
generated in `$NEAR_HOME_DIRECTORY/output`. To see why, note that the
validators field of this genesis file lists all the current mainnet
validators and their keys. So that means if we were to try and start a
test chain from the generated genesis and records files as-is, it
would work, but our node would expect the current mainnet validators
to be producing blocks and chunks (which they definitely won't be!
Because we're the only ones who know or care about this new test
chain).

So we need to select a new list of validators to start off our
chain. Suppose that we want our chain to have two validators,
`validator0.near` and `validator1.near`. Let's make a new directory
where we'll be storing intermediate files during this process:

```shell
$ mkdir ~/test-chain-scratch
```

then using your favorite editor, lay out the validators you want in
the test chain as a JSON list in the same format as the `validators`
field in `genesis.json`, maybe in the file
`~/test-chain-scratch/validators.json`

```json
[
  {
    "account_id": "validator0.near",
    "public_key": "ed25519:GRAFkrqEkJAbdbWUgc6fDnNpCTE83C3pzdJpjAHkMEhq",
    "amount": "100000000000000000000000000000000"
  },
  {
    "account_id": "validator1.near",
    "public_key": "ed25519:5FxQQTC9mk5kLAhTF9ffDMTXiyYrDXyGYskgz46kHMdd",
    "amount": "100000000000000000000000000000000"
  }
]
```

This is also a good time to think about what extra accounts you might
want in your test chain. Since all accounts in the test chain will
have the same keys as they do on mainnet, you'll only have access to
the accounts that you have access to on mainnet. If you want to add an
account with a large balance to properly test things out, you can
write them out in a file as a JSON list of state records (in the same
format as they appear in `records.json`). For example, you could put
the following in `~/test-chain-scratch/extra-records.json`:

```json
[
  {
    "Account": {
      "account_id": "my-test-account.near",
      "account": {
        "amount": "10000000000000000000000000000000000",
        "locked": "0",
        "code_hash": "11111111111111111111111111111111",
        "storage_usage": 182,
        "version": "V1"
      }
    }
  },
  {
    "AccessKey": {
      "account_id": "my-test-account.near",
      "public_key": "ed25519:Eo9W44tRMwcYcoua11yM7Xfr1DjgR4EWQFM3RU27MEX8",
      "access_key": {
        "nonce": 0,
        "permission": "FullAccess"
      }
    }
  }
]
```

You'll want to include an access key here, otherwise you won't be able
to do anything with the account. Note that here you can also add
access keys for any mainnet account you want, so you'll be able to
control it in the test chain.

Now to make these changes to the genesis and records files, you can
use the `neard amend-genesis` command like so:

```shell
# mkdir ~/near-test-chain/
$ neard amend-genesis --genesis-file-in $NEAR_HOME_DIRECTORY/output/genesis.json --records-file-in $NEAR_HOME_DIRECTORY/output/records.json --validators ~/test-chain-scratch/validators.json --extra-records ~/test-chain-scratch/extra-records.json --chain-id $TEST_CHAIN_ID --records-file-out ~/near-test-chain/records.json --genesis-file-out ~/near-test-chain/genesis.json
```

Then you can use the resulting genesis and records files in
`~/near-test-chain/` to start your new chain as you normally would.